# -*- coding: utf-8 -*-
"""Covid_EUA_Traking.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1O_ofDLq8ULvIHSJ6OYlE5kQXSaT3jmmW
"""

# ================================================
# üß† PASSO 1 - Escolher uma base de dados p√∫blica
# ================================================
# Base escolhida: bigquery-public-data.covid19_tracking.city_level_cases_and_deaths
# Tema: Casos e mortes por COVID-19 em cidades dos EUA
# Fonte: Google Cloud Public Datasets
# ================================================


# ================================================
# ‚öôÔ∏è PASSO 2 ‚Äì Configurar o ambiente Python
# ================================================

!pip install pandas-gbq --quiet
!pip install seaborn matplotlib --quiet

import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from pandas_gbq import read_gbq

# Configura√ß√µes visuais
plt.style.use("seaborn-v0_8-whitegrid")
pd.set_option("display.max_columns", 20)

# ================================================
# üìä PASSO 3 ‚Äì Extrair os dados via SQL
# ================================================
query = """
    SELECT
      date,
      state,
      location AS city,
      cases_total,
      daily_new_cases,
      deaths_total,
      daily_new_deaths
    FROM `bigquery-public-data.covid19_tracking.city_level_cases_and_deaths`
    WHERE city_or_county = 'City'
      AND cases_total IS NOT NULL
    ORDER BY date DESC
    LIMIT 5000
"""

# Replace 'your-gcp-project-id' with your actual Google Cloud project ID and specify a location
df = read_gbq(query, project_id="curso-ebac1", dialect='standard')
print("‚úÖ Dados importados com sucesso!\n")
df.head()

# ================================================
# üßπ PASSO 4 ‚Äì Tratamento e explora√ß√£o dos dados
# ================================================

# Verificar dados ausentes
print("üîç Dados ausentes por coluna:")
print(df.isnull().sum(), "\n")

# Converter a coluna de data
df["date"] = pd.to_datetime(df["date"])

# Estat√≠sticas descritivas
print("üìà Estat√≠sticas descritivas:")
print(df.describe(), "\n")

# Informa√ß√µes gerais
df.info()

# Ver as cidades mais recorrentes no dataset
print("\nüèôÔ∏è Top 10 cidades com mais registros:")
print(df["city"].value_counts().head(10))

# ================================================
# üí° PASSO 5 ‚Äì Definir perguntas de neg√≥cio
# ================================================
# 1Ô∏è‚É£ Quais s√£o as cidades com maior n√∫mero total de casos acumulados?
# 2Ô∏è‚É£ Como evolu√≠ram os casos di√°rios ao longo do tempo nas cidades mais afetadas?
# 3Ô∏è‚É£ Qual a rela√ß√£o entre casos e mortes di√°rias?

# ================================================
# üìä PASSO 6 ‚Äì Responder as perguntas com c√≥digo
# ================================================

# 1Ô∏è‚É£ Cidades com maior n√∫mero total de casos acumulados
top_cities = (
    df.groupby("city")["cases_total"]
    .max()
    .sort_values(ascending=False)
    .head(10)
    .reset_index()
)
print("üèÜ Top 10 cidades com mais casos acumulados:")
print(top_cities)

plt.figure(figsize=(10, 5))
sns.barplot(x="cases_total", y="city", data=top_cities, palette="Reds_r")
plt.title("Top 10 Cidades com Mais Casos de COVID-19")
plt.xlabel("Casos Totais")
plt.ylabel("Cidade")
plt.show()

# 2Ô∏è‚É£ Evolu√ß√£o temporal dos casos di√°rios
plt.figure(figsize=(12, 6))
sns.lineplot(data=df[df["city"].isin(top_cities["city"])],
             x="date", y="daily_new_cases", hue="city", linewidth=1.5)
plt.title("Evolu√ß√£o dos Casos Di√°rios nas Cidades Mais Afetadas")
plt.xlabel("Data")
plt.ylabel("Novos Casos Di√°rios")
plt.legend(bbox_to_anchor=(1, 1))
plt.show()

# 3Ô∏è‚É£ Rela√ß√£o entre casos e mortes di√°rias
plt.figure(figsize=(6, 6))
sns.scatterplot(data=df, x="daily_new_cases", y="daily_new_deaths", alpha=0.6)
plt.title("Correla√ß√£o entre Casos e Mortes Di√°rias")
plt.xlabel("Novos Casos")
plt.ylabel("Novas Mortes")
plt.show()

# ================================================
# üßæ PASSO 7 ‚Äì Conclus√£o
# ================================================

print("""
üìä CONCLUS√ïES PRINCIPAIS:

1Ô∏è‚É£ As cidades com maior n√∫mero total de casos acumulados concentram boa parte do impacto da pandemia,
    destacando-se grandes centros urbanos.

2Ô∏è‚É£ Observa-se que os picos de novos casos variam entre as cidades, mas seguem tend√™ncias temporais
    semelhantes, indicando ondas regionais da pandemia.

3Ô∏è‚É£ H√° uma correla√ß√£o positiva entre novos casos e novas mortes di√°rias ‚Äî indicando que o aumento
    no n√∫mero de casos tende a ser seguido por maior n√∫mero de √≥bitos.

üí° Essa an√°lise demonstra o potencial do BigQuery aliado ao Python para realizar an√°lises r√°pidas e
    escal√°veis sobre dados p√∫blicos de alta volumetria.
""")